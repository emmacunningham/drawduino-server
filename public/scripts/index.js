var line = 'scripts/line/';
var vendor = 'scripts/vendor/';
var libs = 'scripts/libs/';
require( [
    "jquery",
    line + "Canvas.js",
    line + "Playback.js",
    vendor + "dropdown.js",
    vendor + "prettify.js",
    vendor + "jquery-ui-1.9.2.custom.min.js",
    vendor + "processing-1.4.1.min.js",
    libs + 'Noduino.js',
    libs + 'Noduino.Socket.js',
    libs + 'Logger.HTML.js'
  ],
  function( $, Canvas, Playback, dropdown, prettify, ui, processing, NoduinoObj, Connector, Logger ) {

    var canvas, playback;

    // Set up UI.

    var UI = {
      TOOLBAR : '#toolbar',
      ERASE : '#erase',
      UNDO : '#undo',
      REDO: '#redo',
      PLAY_DEMO: '#playDemo'
    }

    var setupUi = function() {
      $(UI.ERASE).click( function() {
        shake();
        reset();
      });
       $(UI.UNDO).click( function() {
        canvas.undo();
      });
      $(UI.UNDO).mousedown( function() {
        canvas.startUndoing();
      });
      $(UI.UNDO).mouseup( function() {
        canvas.stopUndoing();
      });
      $(UI.UNDO).mouseout( function() {
        canvas.stopUndoing();
      });
      $(UI.REDO).click( function() {
        canvas.redo();
      });
      $(UI.REDO).mousedown( function() {
        canvas.startRedoing();
      });
      $(UI.REDO).mouseup( function() {
        canvas.stopRedoing();
      });
      $(UI.REDO).mouseout( function() {
        canvas.stopRedoing();
      });
      $(UI.PLAY_DEMO).click( function() {
        playDemo();
      });
      updateHistoryUi();
    }

    // Set up Noduino.

    var Noduino = null;
    var drawObjX;
    var drawObjY;

    var pollForBoard = function() {
      // Poll indefinitely so we can connect and disconnect at will.
      // To-do: Detect disconnection.
      var pollInterval = setInterval( function() {
        if (!Noduino || !Noduino.connected) {
          Noduino = new NoduinoObj({debug: true, host: 'http://localhost:8090', logger: {container: '#connection-log'}}, Connector, Logger);
          Noduino.connect(function(err, board) {
            // Listen to rotary input.
            // Specify which interrupt pin is attached to the rotary encoder.
            // For drawObjX, make sure right pin is attached to interrupt.
            // For drawObjY, make sure left pin is attached to interrupt.
            board.withRotaryInput( { pin: '3' }, createBoardInputHandler( drawObjX )  );
            board.withRotaryInput( { pin: '2' }, createBoardInputHandler( drawObjY ) );
          });
        }
      }, 1000 );
    }

    var INPUT_FACTOR = 5;
    var createBoardInputHandler = function( drawObj ) {
      return function( err, RotaryInput ) {
        RotaryInput.on('change', function(a) {
          if ( !canvas.getIsPlayingHistory() ) {
            var rotaryValue = RotaryInput.value;
            console.log(RotaryInput.value);
            drawObj.cur = rotaryValue;
            if ( drawObj.prev != undefined ) {
              drawObj.delta += ( drawObj.cur - drawObj.prev) * INPUT_FACTOR;
            }
            drawObj.prev = drawObj.cur;
          }
        });
      }
    }

    var showToolbar = function( show ) {
      if ( show ) $(UI.TOOLBAR).show();
      else $(UI.TOOLBAR).hide();
    }

    var onResize = function( e ) {
      canvas.updateSize();
    }

    var onCanvasChange_ = function( e ) {
      updateHistoryUi();
    }

    var onPlaybackStart_ = function() {
      showToolbar( false );
    }

    var onPlaybackStop_ = function() {
      showToolbar( true );
    }

    var shake = function() {
      $( 'body' ).effect( "shake", { direction: 'up', times: 3 }, 600 );
    }

    var reset = function() {
      canvas.reset();
      drawObjX = { prev : undefined, cur : undefined, delta : 0 };
      drawObjY = { prev : undefined, cur : undefined, delta : 0 };
    }

    var drawBuffer = function() {
      if ( drawObjX.delta != 0 || drawObjY.delta != 0 ) {
        canvas.drawLineBy( drawObjX.delta, drawObjY.delta );
        drawObjX.delta = drawObjY.delta = 0;
      }
    }

    var updateHistoryUi = function() {
      var undoHistory = canvas.getUndoHistory(), redoHistory = canvas.getRedoHistory();
      if ( undoHistory.length > 1 ) $(UI.UNDO).removeClass( 'disabled' );
      else $(UI.UNDO).addClass( 'disabled' );
      if ( redoHistory.length > 0 ) $(UI.REDO).removeClass( 'disabled' );
      else $(UI.REDO).addClass( 'disabled' );
    }

    // Testing.

    var testInput = function( drawObj, value ) {
      drawObj.cur = value;
      if ( drawObj.prev != undefined ) {
        drawObj.delta += ( drawObj.cur - drawObj.prev) * INPUT_FACTOR;
      }
      drawObj.prev = drawObj.cur;
    }

    var playDemo = function() {
      //var testHistory = '{"min":{"x":458,"y":464.25},"max":{"x":713.75,"y":720},"line":[[0,0,0],[1000,-42,0],[101,42,0],[304,0.25,0],[507,-0.25,0],[1000,0,0.25],[1000,0,-36],[100,-0.25,35.75],[1000,-0.25,0],[807,-37.5,0],[101,37.5,0],[704,-0.75,0],[101,-3.5,0],[101,-3.25,0],[100,-1.5,-35.75],[100,-5.75,35.75],[101,-3,0],[1000,-1.25,0],[101,-1.25,0],[100,-5.75,0],[100,-4.5,0],[101,-4.75,0],[100,-4.25,0],[101,-1.25,0],[100,-0.75,0],[508,1,0],[103,3.75,0],[103,5,0],[101,-9.75,0],[203,19.75,0],[304,0.25,0.25],[1000,-20,-0.25],[100,20,0],[101,0,3.5],[101,0,4],[102,0,3.5],[101,0,2.75],[101,0,1.75],[102,-20,1],[101,20,-52.25],[101,0,52.75],[1000,-20,0],[100,19.75,0],[102,0.25,0],[101,0,0.25],[101,0,0.75],[101,0,2],[101,-1,5.75],[101,0,6.25],[101,-1.5,4.75],[101,-1.25,18.75],[100,-15,15],[104,12,13],[100,-1.5,7],[101,-1.75,13],[100,-1.75,11.5],[101,-1.5,18.25],[100,-0.75,7],[101,-6,19.25],[101,4,12],[100,-1,13],[101,-1.25,0],[101,0,17.5],[101,-1.5,14.5],[100,0,1],[1000,0,0.25],[1000,-0.25,0],[1000,0,-10.25],[100,0,-9],[101,0,-16.5],[100,0,-18],[104,0,-199.75],[99,0,154.25],[101,0,-22.75],[100,0,-22],[100,0,-18.75],[201,0,-9.25],[706,0,40],[101,0,18.5],[101,2,17],[101,2,17.5],[101,1.75,17],[101,1.75,12.25],[101,1,4],[101,1.75,4.5],[100,0.75,19.75],[101,0,-232],[101,1.25,0],[101,0.5,255],[102,1.75,-229.25],[101,0,230],[101,0.75,0],[101,1,0],[201,1,0],[202,0.75,0],[101,0.75,0],[101,0.75,0],[201,0.75,0],[101,0,-0.75],[100,0.5,-10.75],[101,0,-32.25],[101,0,-30],[100,-20.75,-26.75],[101,22,-21],[100,0.75,-21],[101,0.75,-17.25],[101,2.25,-14],[102,1.5,-12.75],[100,1.5,-10.25],[102,1.25,-6],[100,1.5,-1.75],[102,1.25,-1],[101,0.75,-1.25],[101,0.75,-1.25],[102,1.25,0],[201,-0.25,0],[104,0,-0.75],[604,1.25,-3],[101,2,-2.25],[101,2,-2.25],[100,1.5,-2.25],[101,0,-2.5],[101,3.5,-2.25],[101,1.5,-2.25],[101,1.75,-2.25],[101,1,-1],[101,2.75,-2.75],[101,12.75,-3.5],[101,12.25,-2.25],[101,15.25,-2.25],[101,13.75,-2.5],[101,6.25,-2.25],[100,19.75,-1],[101,13.75,-2.5],[100,13.5,-2],[100,14,-1.75],[101,14.5,-0.75],[101,12,-2.25],[101,13.25,-0.75],[101,12,0],[100,5,0],[102,9.5,0],[101,8,0],[100,4.5,0],[101,0.75,0],[101,0.75,0],[100,0.5,0],[202,1.25,0],[707,-250,0],[101,250,0],[101,-255.75,0],[101,255.75,0]]}';
      //var testHistory = '{"min":{"x":-413.5,"y":-435.5},"max":{"x":0,"y":0},"line":[[0,-413.5,-435.5],[2,-413.5,-435.5],[3,-455.5,-435.5],[501,-413.5,-435.5],[52,-413.25,-435.5],[154,-413.5,-435.5],[254,-413.5,-435.25],[502,-413.5,-471.25],[502,-413.75,-435.5],[52,-414,-435.5],[502,-451.5,-435.5],[405,-414,-435.5],[52,-414.75,-435.5],[353,-418.25,-435.5],[51,-421.5,-435.5],[53,-423,-471.25],[52,-428.75,-435.5],[52,-431.75,-435.5],[52,-433,-435.5],[502,-434.25,-435.5],[51,-440,-435.5],[52,-444.5,-435.5],[52,-449.25,-435.5],[52,-453.5,-435.5],[53,-454.75,-435.5],[51,-455.5,-435.5],[52,-454.5,-435.5],[257,-450.75,-435.5],[52,-445.75,-435.5],[54,-455.5,-435.5],[51,-435.75,-435.5],[104,-435.5,-435.25],[154,-455.5,-435.5],[502,-435.5,-435.5],[51,-435.5,-432],[52,-435.5,-428],[53,-435.5,-424.5],[52,-435.5,-421.75],[52,-435.5,-420],[52,-455.5,-419],[53,-435.5,-471.25],[52,-435.5,-418.5],[52,-455.5,-418.5],[501,-435.75,-418.5],[52,-435.5,-418.5],[52,-435.5,-418.25],[52,-435.5,-417.5],[52,-435.5,-415.5],[52,-436.5,-409.75],[51,-436.5,-403.5],[52,-438,-398.75],[52,-439.25,-380],[52,-454.25,-365],[52,-442.25,-352],[54,-443.75,-345],[52,-445.5,-332],[52,-447.25,-320.5],[51,-448.75,-302.25],[53,-449.5,-295.25],[52,-455.5,-276],[51,-451.5,-264],[51,-452.5,-251],[52,-453.75,-251],[52,-453.75,-233.5],[52,-455.25,-219],[51,-455.25,-218],[52,-455.25,-217.75],[501,-455.5,-217.75],[502,-455.5,-228],[501,-455.5,-237],[52,-455.5,-253.5],[52,-455.5,-271.5],[52,-455.5,-471.25],[53,-455.5,-317],[51,-455.5,-339.75],[51,-455.5,-361.75],[51,-455.5,-380.5],[52,-455.5,-389.75],[102,-455.5,-349.75],[354,-455.5,-331.25],[51,-453.5,-314.25],[51,-451.5,-296.75],[52,-449.75,-279.75],[52,-448,-267.5],[52,-447,-263.5],[51,-445.25,-259],[52,-444.5,-239.25],[52,-444.5,-471.25],[52,-443.25,-471.25],[51,-442.75,-216.25],[52,-441,-445.5],[54,-441,-215.5],[53,-440.25,-215.5],[51,-439.25,-215.5],[52,-438.25,-215.5],[101,-437.5,-215.5],[104,-436.75,-215.5],[52,-436,-215.5],[52,-435.25,-215.5],[101,-435.25,-216.25],[52,-434.75,-227],[53,-434.75,-259.25],[51,-434.75,-289.25],[52,-455.5,-316],[51,-433.5,-337],[52,-432.75,-358],[52,-432,-375.25],[51,-429.75,-389.25],[51,-428.25,-402],[53,-426.75,-412.25],[51,-425.5,-418.25],[53,-424,-420],[51,-422.75,-421],[53,-422,-422.25],[51,-421.25,-423.5],[52,-420,-423.5],[53,-420.25,-423.5],[102,-420.25,-424.25],[54,-419,-427.25],[304,-417,-429.5],[52,-415,-431.75],[51,-413.5,-434],[52,-413.5,-436.5],[53,-410,-438.75],[51,-408.5,-441],[52,-406.75,-443.25],[52,-405.75,-444.25],[52,-403,-447],[52,-390.25,-450.5],[53,-378,-452.75],[51,-362.75,-455],[53,-349,-457.5],[53,-342.75,-459.75],[51,-323,-460.75],[52,-309.25,-463.25],[51,-295.75,-465.25],[51,-281.75,-467],[52,-267.25,-467.75],[52,-255.25,-470],[52,-242,-470.75],[52,-230,-470.75],[52,-225,-470.75],[52,-215.5,-470.75],[53,-207.5,-470.75],[51,-203,-470.75],[52,-202.25,-470.75],[51,-201.5,-470.75],[52,-201,-470.75],[52,-199.75,-470.75],[103,-449.75,-470.75],[355,-199.75,-470.75],[52,-455.5,-470.75],[52,-199.75,-470.75]]}';

      // This data is based off the center as the origin.
      var testHistory = '{"min":{"x":0,"y":0},"max":{"x":0,"y":0},"line":[[0,-72.375,-56.625],[2,-85.875,-92.125],[2,-85.875,-92.125],[3,-127.875,-92.125],[2,-85.875,-92.125],[250,-85.625,-92.125],[27,-85.875,-92.125],[78,-85.875,-91.875],[129,-85.875,-127.875],[253,-86.125,-92.125],[253,-86.375,-92.125],[27,-123.875,-92.125],[252,-86.375,-92.125],[204,-87.125,-92.125],[27,-90.625,-92.125],[177,-93.875,-92.125],[26,-95.375,-127.875],[27,-101.125,-92.125],[27,-104.125,-92.125],[27,-105.375,-92.125],[27,-106.625,-92.125],[253,-112.375,-92.125],[26,-116.875,-92.125],[27,-121.625,-92.125],[27,-125.875,-92.125],[27,-127.125,-92.125],[27,-127.875,-92.125],[26,-126.875,-92.125],[27,-123.125,-92.125],[129,-118.125,-92.125],[27,-127.875,-92.125],[28,-108.125,-92.125],[26,-107.875,-91.875],[53,-127.875,-92.125],[79,-107.875,-92.125],[252,-107.875,-88.625],[26,-107.875,-84.625],[27,-107.875,-81.125],[27,-107.875,-78.375],[27,-107.875,-76.625],[28,-127.875,-75.625],[27,-107.875,-127.875],[27,-107.875,-75.125],[27,-127.875,-75.125],[27,-108.125,-75.125],[251,-107.875,-75.125],[27,-107.875,-74.875],[27,-107.875,-74.125],[27,-107.875,-72.125],[27,-108.875,-66.375],[27,-108.875,-60.125],[26,-110.375,-55.375],[27,-111.625,-36.625],[27,-126.625,-21.625],[28,-114.625,-8.625],[28,-116.125,-1.625],[28,-117.875,11.375],[27,-119.625,22.875],[28,-121.125,41.125],[26,-121.875,48.125],[28,-127.875,67.375],[27,-123.875,79.375],[26,-124.875,92.375],[26,-126.125,92.375],[27,-126.125,109.875],[27,-127.625,124.375],[27,-127.625,125.375],[26,-127.625,125.625],[27,-127.875,125.625],[252,-127.875,115.375],[252,-127.875,106.375],[251,-127.875,89.875],[27,-127.875,71.875],[28,-127.875,-127.875],[27,-127.875,26.375],[27,-127.875,3.625],[26,-127.875,-18.375],[26,-127.875,-37.125],[26,-127.875,-46.375],[27,-127.875,-6.375],[52,-127.875,12.125],[177,-125.875,29.125],[26,-123.875,46.625],[26,-122.125,63.625],[27,-120.375,75.875],[28,-119.375,79.875],[27,-117.625,84.375],[26,-116.875,104.125],[27,-116.875,-127.875],[28,-115.625,-127.875],[27,-115.125,127.125],[26,-113.375,-102.125],[27,-113.375,127.875],[28,-112.625,127.875],[27,-111.625,127.875],[26,-110.625,127.875],[27,-109.875,127.875],[51,-109.125,127.875],[53,-108.375,127.875],[27,-107.625,127.875],[38,-107.625,127.125],[52,-107.125,116.375],[27,-107.125,84.125],[27,-107.125,54.125],[26,-127.875,27.375],[27,-105.875,6.375],[26,-105.125,-14.625],[28,-104.375,-31.875],[27,-102.125,-45.875],[26,-100.625,-58.625],[26,-99.125,-68.875],[27,-97.875,-74.875],[26,-96.375,-76.625],[27,-95.125,-77.625],[26,-94.375,-78.875],[27,-93.625,-80.125],[27,-92.375,-80.125],[26,-92.625,-80.125],[27,-92.625,-80.875],[52,-91.375,-83.875],[29,-89.375,-86.125],[152,-87.375,-88.375],[28,-85.875,-90.625],[26,-85.875,-93.125],[27,-82.375,-95.375],[27,-80.875,-97.625],[27,-79.125,-99.875],[27,-78.125,-100.875],[27,-75.375,-103.625],[28,-62.625,-107.125],[28,-50.375,-109.375],[27,-35.125,-111.625],[26,-21.375,-114.125],[28,-15.125,-116.375],[27,4.625,-117.375],[26,18.375,-119.875],[27,31.875,-121.875],[26,45.875,-123.625],[26,60.375,-124.375],[27,72.375,-126.625],[27,85.625,-127.375],[27,97.625,-127.375],[28,102.625,-127.375],[27,112.125,-127.375],[27,120.125,-127.375],[27,124.625,-127.375],[26,125.375,-127.375],[27,126.125,-127.375],[26,126.625,-127.375],[27,127.875,-127.375],[27,-122.125,-127.375],[53,127.875,-127.375],[178,-127.875,-127.375],[27,127.875,-127.375]]}';
      playback.play( testHistory );
    }

    // Init.

    $(document).ready(function(e) {
      canvas = new Canvas( document.getElementById( 'canvas' ) );
      canvas.addEventListener( Canvas.Event.CHANGE, onCanvasChange_ );
      playback = new Playback( canvas );
      playback.addEventListener( Playback.Event.START, onPlaybackStart_ );
      playback.addEventListener( Playback.Event.STOP, onPlaybackStop_ );

      // UI.
      reset();
      setupUi();
      setInterval( drawBuffer, 50 );
      pollForBoard();

      // Testing.
      canvas.$get().click( function( e ) {
        console.log(canvas.getHistoryString())
        //var range = 200;
        //testInput( drawObjX, Math.round( Math.random() * range - range * .5 ) );
        //testInput( drawObjY, Math.round( Math.random() * range - range * .5 ) );
      });

      $( document ).keypress( function( e ) {
        switch( e.keyCode ) {
          case 96:
            $('#connection-log').fadeToggle();
            break;
        }
      });

      $( window ).resize( onResize );
    });

  }
);